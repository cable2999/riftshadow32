<?
	include("../header.inc");

	$fp = fopen($def_path . "autogen/coldefs.h", "w");

	fwrite($fp, "/* This file is auto-generated by Riftshadow Admin Website. Do not modify. */\n");

	$table_list = mysql_list_tables("rift_core");

	while(list($table_name) = mysql_fetch_array($table_list))
	{
		$fields = mysql_list_fields("rift_core", $table_name, $core_conn);
		$columns = mysql_num_fields($fields);

		$m_var = "";

		if("$table_name" == "world_rooms")
		{
			$m_var .= "#define\tLOAD_EXIT_DATA(eptr)\\\n";
			$m_var .= "eptr->exit_info = eptr->RowToNumber(COL_WORLD_ROOMS_0_EXIT_INFO);\\\n";
			$m_var .= "eptr->key = eptr->RowToNumber(COL_WORLD_ROOMS_0_KEY);\\\n";
			$m_var .= "eptr->keyword.NoDeallocSetTo(COL_WORLD_ROOMS_0_KEYWORD);\n\n";						
		}

		$m_var .= "#define\tLOAD_" . strtoupper($table_name) . "(tvar)\\\n";

		if("$table_name" == "world_rooms")
			$m_var .= "ASSOCIATE_AREA(tvar, row[COL_WORLD_ROOMS_AREA_ID]);\\\n";

		for ($i = 0; $i < $columns; $i++)
		{
			$f_name = mysql_field_name($fields, $i);
			$f_type =  mysql_field_type($fields, $i);
			$flags = mysql_field_flags($fields, $i);
			$flag_list = explode(" ", $flags);
			$first_flag = $flag_list[0];
			$d_name = strtoupper("COL_" . $table_name . "_$f_name");
			$line = "#define\t$d_name\t\t$i\n";
			
			$go = 1;
			for($j=0; $j < 10; $j++)
				if($flag_list[$j] == "auto_increment")
					$go = 0;

			if("$f_type" == "string" && "$first_flag" == "")
				$go = 0;

            if("$f_name" == "max_str")
                $f_name = "max_stats[0]";
            if("$f_name" == "max_int")
                $f_name = "max_stats[1]";
            if("$f_name" == "max_wis")
                $f_name = "max_stats[2]";
            if("$f_name" == "max_dex")
                $f_name = "max_stats[3]";
            if("$f_name" == "max_con")
                $f_name = "max_stats[4]";


			// world related id columns that shouldn't show up
			if("$d_name" == "COL_WORLD_AREAS_ID")
				$go = 0;

			// exit info for world_rooms that doesn't need to display.
			if((strpos($f_name, "_to_room") == "1" ||
			   strpos($f_name, "_exit_info") == "1" ||
			   strpos($f_name, "_key") == "1" ||
			   strpos($f_name, "_keyword") == "1") && "$table_name" == "world_rooms")
			{
				fwrite($fp, $line);
				$go = 0;
			}

			if($go)
			{
				fwrite($fp, $line);
				if("$f_name" == "do_fun_name")
				{
					$m_var .= "tvar.do_fun.SetPtr((void *)do_fun_table[i].name);";
				}
				else if("$f_type" == "int")
				{
					if("$first_flag" == "")
						$m_var .= "tvar.$f_name.SetToDouble(row[$d_name]);";
					else
						$m_var .= "tvar.$f_name = row.RowToNumber($d_name);";
				}
				else if("$f_type" == "string" || "$f_type" == "blob")
				{
					$m_var .= "tvar.$f_name.NoDeallocSetTo(row[$d_name]);";
				}
				else if("$f_type" == "real")
				{
					$m_var .= "tvar.$f_name = row.RowToFloat($d_name);";
				}
				else
					die("Error with field types! - $f_name, $f_type");

				// Add the allocate_exits macro for loading rooms from world_rooms - needs to be near the end.
				if("$d_name" == "COL_WORLD_ROOMS_OWNER")
				{
					$m_var .= "\\\n";
					$m_var .= "ALLOCATE_EXITS(tvar);";
				}
				

				if(($i + 1) != $columns)
					$m_var .= "\\";

				$m_var .= "\n";
			}
		}

		fwrite ($fp, "\n$m_var\n");
	}

	fclose($fp);

	$fp = fopen($def_path . "autogen/fundefs.h", "w");

	$ic = fopen($def_path . "temp_interp.c", "w");
    fwrite ($ic, "#include \"character.h\"\n\n\n");

	/* kick out the interp do_funs */
	$dofunargs = "CCharacter *ch, const char *args";
	fwrite ($fp, "typedef void (*DOFUNTYPE) ($dofunargs);\n");
	fwrite ($fp, "struct do_fun_type{ DOFUNTYPE name; };\n");

	/* we have to prototype the do_funs first */
	$pre_dec = mysql_db_query("rift_core","select distinct do_fun_name from interp_table order by id asc", $conn);
	for($j=0; $irow = mysql_fetch_array($pre_dec); $j++)
	{
		fwrite ($fp, "void $irow[do_fun_name] ($dofunargs);\n");
		fwrite ($ic, "void $irow[do_fun_name]($dofunargs)\n{\n\treturn;\n}\n\n");
	}
	fwrite ($fp, "const struct do_fun_type do_fun_table[] =\n{\n");

	$get_ires = mysql_db_query("rift_core","select distinct do_fun_name from interp_table order by id asc", $conn);
	for($j=0; $irow = mysql_fetch_array($get_ires); $j++)
		fwrite ($fp, "\t{ $irow[do_fun_name] },\n");
	fwrite ($fp, "};\n");

	fclose($ic);
	fclose($fp);

	$fp = fopen($def_path . "autogen/stddefs.h", "w");
	$get_b = mysql_db_query("rift_core", "select define, bit from bit_lookup", $conn); 
	for($j=0; $row = mysql_fetch_array($get_b); $j++)
		fwrite ($fp, "#define $row[0]\t\t\t$row[1]\n");
	$get_d = mysql_db_query("rift_core", "select define, value from d_lookup", $conn);
	for($j=0; $row = mysql_fetch_array($get_d); $j++)
		fwrite ($fp, "#define $row[0]\t\t\t$row[1]\n");
	fclose($fp);


//	chmod ( $def_path . "autogen/coldefs.h", 0755);

	echo "<pre>";
	echo "File: " . $def_path . "autogen/coldefs.h has been populated.\n";
	echo "File: " . $def_path . "autogen/fundefs.h has been populated.\n";
	echo "File: " . $def_path . "temp_interp.c has been populated.\n";
	echo "File: " . $def_path . "autogen/stddefs.h has been populated.\n";
	echo "</pre>";


	include("../footer.inc");
?>
